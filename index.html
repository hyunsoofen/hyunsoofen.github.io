import React, { useState, useEffect, useRef } from 'react';
import { 
  Briefcase, 
  Cpu, 
  Globe, 
  Cloud, 
  Code, 
  TrendingUp, 
  Mail, 
  Linkedin, 
  ExternalLink,
  Award,
  ChevronRight,
  Database,
  BookOpen,
  Zap,
  Bot,
  ArrowLeft,
  Calendar,
  Clock,
  Sparkles,
  Play,
  Pause,
  RotateCcw,
  Loader2,
  Send
} from 'lucide-react';

const apiKey = ""; // API key is provided at runtime

const App = () => {
  const [currentPage, setCurrentPage] = useState('home'); 
  const [selectedEssay, setSelectedEssay] = useState(null);
  const [isScrolled, setIsScrolled] = useState(false);
  
  // Gemini State
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [aiSummary, setAiSummary] = useState("");
  const [brainstormInput, setBrainstormInput] = useState("");
  const [brainstormResult, setBrainstormResult] = useState("");
  const [isTtsPlaying, setIsTtsPlaying] = useState(false);
  const audioRef = useRef(null);

  useEffect(() => {
    const handleScroll = () => {
      setIsScrolled(window.scrollY > 50);
    };
    window.addEventListener('scroll', handleScroll);
    return () => window.removeEventListener('scroll', handleScroll);
  }, []);

  // --- Gemini API Utilities ---
  const callGemini = async (prompt, systemInstruction = "") => {
    let delay = 1000;
    for (let i = 0; i < 5; i++) {
      try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] }
          })
        });
        if (!response.ok) throw new Error('API request failed');
        const data = await response.json();
        return data.candidates?.[0]?.content?.parts?.[0]?.text;
      } catch (error) {
        if (i === 4) throw error;
        await new Promise(resolve => setTimeout(resolve, delay));
        delay *= 2;
      }
    }
  };

  const callGeminiTTS = async (text) => {
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `Say clearly and professionally: ${text}` }] }],
          generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: {
              voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } }
            }
          }
        })
      });
      const data = await response.json();
      const inlineData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData;
      if (!inlineData) return null;

      // Extract sample rate from mimeType (e.g., "audio/L16;rate=24000")
      const sampleRate = parseInt(inlineData.mimeType.split('rate=')[1]) || 24000;
      const pcmData = new Int16Array(Uint8Array.from(atob(inlineData.data), c => c.charCodeAt(0)).buffer);
      
      return pcmToWav(pcmData, sampleRate);
    } catch (error) {
      console.error("TTS Error:", error);
      return null;
    }
  };

  const pcmToWav = (pcmData, sampleRate) => {
    const buffer = new ArrayBuffer(44 + pcmData.length * 2);
    const view = new DataView(buffer);
    const writeString = (offset, string) => {
      for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
    };
    writeString(0, 'RIFF');
    view.setUint32(4, 32 + pcmData.length * 2, true);
    writeString(8, 'WAVE');
    writeString(12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    writeString(36, 'data');
    view.setUint32(40, pcmData.length * 2, true);
    for (let i = 0; i < pcmData.length; i++) view.setInt16(44 + i * 2, pcmData[i], true);
    return new Blob([buffer], { type: 'audio/wav' });
  };

  // --- Features Logic ---
  const handleAiSummarize = async () => {
    if (!selectedEssay) return;
    setIsAiLoading(true);
    try {
      const summary = await callGemini(
        `Summarize the following essay in 3 bullet points in Korean. \n\nTitle: ${selectedEssay.title}\nContent: ${selectedEssay.content}`,
        "You are a helpful ICT strategy assistant. Keep the tone professional."
      );
      setAiSummary(summary);
    } catch (e) {
      setAiSummary("요약 생성 중 오류가 발생했습니다.");
    } finally {
      setIsAiLoading(false);
    }
  };

  const handleBrainstorm = async () => {
    if (!brainstormInput.trim()) return;
    setIsAiLoading(true);
    setBrainstormResult("");
    try {
      const result = await callGemini(
        `Generate a brief 3-point business partnership strategy for the following tech domain: "${brainstormInput}". Focus on South Korean market context like SK or LG. Response in Korean.`,
        "You are an expert ICT business strategist."
      );
      setBrainstormResult(result);
    } catch (e) {
      setBrainstormResult("전략 수립 중 오류가 발생했습니다.");
    } finally {
      setIsAiLoading(false);
    }
  };

  const handleTtsPlay = async () => {
    if (isTtsPlaying) {
      audioRef.current?.pause();
      setIsTtsPlaying(false);
      return;
    }
    
    if (audioRef.current && audioRef.current.src) {
      audioRef.current.play();
      setIsTtsPlaying(true);
      return;
    }

    setIsAiLoading(true);
    const audioBlob = await callGeminiTTS(selectedEssay.summary); // Summarize for TTS
    if (audioBlob) {
      const url = URL.createObjectURL(audioBlob);
      const audio = new Audio(url);
      audioRef.current = audio;
      audio.onended = () => setIsTtsPlaying(false);
      audio.play();
      setIsTtsPlaying(true);
    }
    setIsAiLoading(false);
  };

  // --- Mock Data: Career ---
  const careerData = [
    {
      company: "LG Electronics",
      role: "Business Strategy & Partnership Manager",
      period: "Present",
      description: "Leading strategic initiatives and global partnerships for webOS Auto, driving the future of software-defined vehicles (SDV).",
      tags: ["webOS Auto", "Strategy", "Automotive", "Partnership"],
      color: "from-red-600 to-rose-500"
    },
    {
      company: "SK holdings C&C",
      role: "Digital Business Manager & Associate",
      period: "8+ Years",
      description: "Expertise in ICT infrastructure, AI strategy (Watson/Abrill), Cloud PaaS, and Enterprise software development.",
      tags: ["AI/Abrill", "Cloud PaaS", "ICT Infra", "Big Data"],
      color: "from-orange-500 to-amber-400"
    }
  ];

  // --- Mock Data: Essays ---
  const essays = [
    {
      id: 1,
      title: "2026 자율주행 시장의 판도 변화: 하드웨어에서 소프트웨어 중심(SDV)으로",
      category: "AI & Auto",
      date: "2026.01.05",
      readTime: "8 min",
      summary: "최근 화웨이와 모멘타의 약진을 통해 본 SDV(Software Defined Vehicle) 전략의 핵심과 글로벌 완성차 업계의 파트너십 변화를 분석합니다.",
      content: `자율주행 기술은 이제 단순히 '운전 보조'를 넘어 차량의 핵심 가치를 결정하는 OS의 싸움으로 번지고 있습니다. 특히 LG전자의 webOS Auto나 화웨이의 Qiankun 솔루션은 차량의 하드웨어 스펙보다 '사용자 경험'과 '지속적인 업데이트'가 얼마나 중요한지 보여줍니다.\n\n본문에서는 엔드투엔드(End-to-End) AI 모델이 가져온 혁신과, 제조사가 특정 칩셋에 종속되지 않기 위해 취해야 할 포팅(Porting) 전략에 대해 다룹니다. 자동차는 이제 달리는 스마트폰이 아닌, 거대한 AI 에이전트가 되고 있습니다.`
    },
    {
      id: 2,
      title: "로보틱스 기반의 기업 협력 전략: 왜 로봇은 '서비스'가 되어야 하는가",
      category: "Robotics",
      date: "2025.12.20",
      readTime: "10 min",
      summary: "단일 로봇 판매 모델의 한계를 극복하기 위한 RaaS(Robotics as a Service) 전략과 이종 산업 간의 데이터 결합 비즈니스 모델을 제안합니다.",
      content: `로보틱스 산업의 핵심은 하드웨어가 아니라 그 하드웨어가 생성하는 '데이터'와 '서비스 시나리오'에 있습니다. SK C&C에서의 Watson 사업 경험을 바탕으로, 로봇 엔진과 대규모 언어 모델(LLM)이 결합되었을 때 발생하는 비즈니스 기회를 분석합니다. 로봇이 인간의 언어를 이해하고 물리적 환경에서 행동으로 옮기는 VLA(Vision-Language-Action) 모델의 도입은 B2B 시장의 게임 체인저가 될 것입니다.`
    },
    {
      id: 3,
      title: "글로벌 테크 거인들과의 파트너십 협상 기술",
      category: "Strategy",
      date: "2025.11.15",
      readTime: "6 min",
      summary: "Qualcomm, NVIDIA 등 글로벌 칩 메이커들과의 전략적 파트너십 수립 시 고려해야 할 SLA 체계와 API 가격 정책 수립의 실제 노하우를 공유합니다.",
      content: `성공적인 파트너십은 상호 이익의 균형에서 시작됩니다. 특히 AI API 비즈니스에서는 연산량 기반의 과금 체계와 서비스 품질 보장(SLA)이 계약의 성패를 가릅니다. T Cloud Biz와 Next TV PaaS 구축 과정에서 겪었던 협상 사례를 통해 본 전략적 접근법을 논의합니다. 글로벌 칩셋 벤더들과의 협상 테이블에서 우리만의 SW 경쟁력을 어떻게 가치로 환산할 것인지가 핵심입니다.`
    }
  ];

  const handleOpenEssay = (essay) => {
    setSelectedEssay(essay);
    setAiSummary("");
    setCurrentPage('essay');
    window.scrollTo(0, 0);
  };

  const handleGoBack = () => {
    setCurrentPage('home');
    setSelectedEssay(null);
    if (audioRef.current) {
      audioRef.current.pause();
      setIsTtsPlaying(false);
    }
  };

  // --- Home Page Component ---
  const HomePage = () => (
    <>
      {/* Hero Section */}
      <section className="pt-32 pb-20 lg:pt-48 lg:pb-32 relative overflow-hidden bg-white">
        <div className="absolute top-0 right-0 w-1/3 h-full bg-blue-50/50 skew-x-12 transform origin-top-right -z-10" />
        <div className="container mx-auto px-6 grid lg:grid-cols-2 gap-12 items-center">
          <div className="space-y-8">
            <div className="inline-flex items-center space-x-2 bg-blue-50 text-blue-700 px-4 py-1.5 rounded-full text-sm font-medium">
              <span className="flex h-2 w-2 rounded-full bg-blue-600 animate-pulse" />
              <span>ICT Industry Strategy & Tech Essayist</span>
            </div>
            <h1 className="text-5xl lg:text-7xl font-extrabold text-slate-900 leading-tight">
              Tech Visionary <br />
              <span className="text-blue-600 underline decoration-blue-200 decoration-8 underline-offset-4 text-4xl lg:text-6xl">ICT Specialist.</span>
            </h1>
            <p className="text-lg text-slate-600 max-w-lg leading-relaxed">
              SK C&C와 LG전자를 거치며 쌓은 AI, 클라우드, 자율주행 기술 인사이트를 공유합니다. 기술과 전략의 접점을 탐구합니다.
            </p>
            
            {/* ✨ AI Strategy Brainstormer Tool */}
            <div className="bg-slate-50 border border-slate-200 p-6 rounded-3xl shadow-sm space-y-4 max-w-lg">
              <div className="flex items-center space-x-2 text-blue-600 font-bold text-sm uppercase tracking-widest">
                <Sparkles size={16} /> <span>AI Strategy Brainstormer</span>
              </div>
              <div className="flex space-x-2">
                <input 
                  type="text" 
                  placeholder="예: '전고체 배터리', '엣지 컴퓨팅'"
                  className="flex-grow bg-white border border-slate-300 px-4 py-2 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                  value={brainstormInput}
                  onChange={(e) => setBrainstormInput(e.target.value)}
                />
                <button 
                  onClick={handleBrainstorm}
                  disabled={isAiLoading}
                  className="bg-blue-600 text-white p-2 rounded-xl hover:bg-blue-700 transition-colors disabled:opacity-50"
                >
                  {isAiLoading ? <Loader2 size={20} className="animate-spin" /> : <Send size={20} />}
                </button>
              </div>
              {brainstormResult && (
                <div className="bg-white border-l-4 border-blue-600 p-4 rounded-lg text-sm text-slate-700 whitespace-pre-line animate-in fade-in slide-in-from-top-2 duration-500">
                  <div className="font-bold text-blue-600 mb-2">✨ AI 제안 전략:</div>
                  {brainstormResult}
                </div>
              )}
            </div>

            <div className="flex space-x-4">
              <a href="#essays" className="bg-slate-900 text-white px-8 py-4 rounded-xl font-bold shadow-lg shadow-slate-200 hover:bg-black transition-all transform hover:-translate-y-1">
                Read Essays
              </a>
            </div>
          </div>
          <div className="relative group hidden lg:block">
            <div className="absolute -inset-4 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-3xl blur-2xl opacity-50 group-hover:opacity-100 transition duration-1000"></div>
            <div className="relative bg-white border border-slate-100 p-8 rounded-3xl shadow-xl space-y-6">
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-slate-50 p-6 rounded-2xl">
                  <Bot className="text-blue-600 mb-4" />
                  <div className="text-2xl font-bold">Robotics</div>
                  <div className="text-sm text-slate-500 uppercase tracking-wider">Strategy</div>
                </div>
                <div className="bg-slate-50 p-6 rounded-2xl">
                  <Cpu className="text-blue-600 mb-4" />
                  <div className="text-2xl font-bold">AI</div>
                  <div className="text-sm text-slate-500 uppercase tracking-wider">Analysis</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* Essays Section */}
      <section id="essays" className="py-24 bg-slate-50">
        <div className="container mx-auto px-6">
          <div className="flex flex-col md:flex-row justify-between items-end mb-16 gap-6">
            <div className="space-y-4">
              <h2 className="text-sm font-bold text-blue-600 uppercase tracking-widest">Thought Leadership</h2>
              <h3 className="text-4xl font-black text-slate-900">Latest Insights & Essays</h3>
            </div>
          </div>

          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
            {essays.map((essay) => (
              <div 
                key={essay.id} 
                onClick={() => handleOpenEssay(essay)}
                className="group bg-white p-8 rounded-3xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-2 transition-all duration-300 cursor-pointer flex flex-col h-full"
              >
                <div className="flex items-center justify-between mb-6">
                  <span className="bg-blue-50 text-blue-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">
                    {essay.category}
                  </span>
                  <div className="flex items-center text-slate-400 text-xs">
                    <Clock size={14} className="mr-1" /> {essay.readTime}
                  </div>
                </div>
                <h4 className="text-xl font-bold text-slate-900 mb-4 group-hover:text-blue-600 transition-colors leading-tight">
                  {essay.title}
                </h4>
                <p className="text-slate-600 text-sm leading-relaxed mb-8 flex-grow">
                  {essay.summary}
                </p>
                <div className="flex items-center justify-between mt-auto pt-6 border-t border-slate-50">
                  <span className="text-xs text-slate-400">{essay.date}</span>
                  <span className="text-blue-600 font-bold text-sm flex items-center group-hover:translate-x-1 transition-transform">
                    Read Full Essay <ChevronRight size={16} />
                  </span>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* Experience Section */}
      <section id="experience" className="py-24 bg-white">
        <div className="container mx-auto px-6">
          <div className="text-center mb-16">
            <h3 className="text-4xl font-black text-slate-900">Career Evolution</h3>
          </div>
          <div className="grid lg:grid-cols-2 gap-8">
            {careerData.map((exp, idx) => (
              <div key={idx} className="group relative">
                <div className={`absolute -inset-0.5 bg-gradient-to-r ${exp.color} rounded-3xl opacity-0 group-hover:opacity-10 shadow-2xl transition duration-500`}></div>
                <div className="relative bg-white p-8 lg:p-10 rounded-3xl border border-slate-100 shadow-sm flex flex-col h-full">
                  <div className="flex justify-between items-start mb-6">
                    <div>
                      <span className={`px-4 py-1.5 rounded-lg text-xs font-bold text-white bg-gradient-to-r ${exp.color}`}>
                        {exp.period}
                      </span>
                      <h4 className="text-2xl font-bold mt-4 text-slate-900">{exp.company}</h4>
                      <p className="text-blue-600 font-medium text-sm mt-1 uppercase tracking-wide">{exp.role}</p>
                    </div>
                  </div>
                  <p className="text-slate-600 leading-relaxed mb-8">{exp.description}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>
    </>
  );

  // --- Essay Detail Page Component ---
  const EssayDetailPage = ({ essay }) => (
    <section className="pt-40 pb-24 bg-white min-h-screen">
      <div className="container mx-auto px-6 max-w-4xl">
        <div className="flex justify-between items-center mb-12">
          <button 
            onClick={handleGoBack}
            className="flex items-center text-slate-500 hover:text-blue-600 transition-colors font-semibold group"
          >
            <ArrowLeft size={20} className="mr-2 group-hover:-translate-x-1 transition-transform" /> Back
          </button>
          
          {/* ✨ AI Tools Bar */}
          <div className="flex space-x-2">
            <button 
              onClick={handleTtsPlay}
              disabled={isAiLoading}
              className="flex items-center bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl text-sm font-bold transition-all disabled:opacity-50"
            >
              {isAiLoading ? <Loader2 size={16} className="animate-spin mr-2" /> : isTtsPlaying ? <Pause size={16} className="mr-2" /> : <Play size={16} className="mr-2" />}
              <span>✨ Listen</span>
            </button>
            <button 
              onClick={handleAiSummarize}
              disabled={isAiLoading}
              className="flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-lg shadow-blue-100 transition-all disabled:opacity-50"
            >
              {isAiLoading ? <Loader2 size={16} className="animate-spin mr-2" /> : <Sparkles size={16} className="mr-2" />}
              <span>✨ Summarize</span>
            </button>
          </div>
        </div>

        <div className="space-y-8">
          <div className="flex items-center space-x-4">
            <span className="bg-blue-600 text-white px-4 py-1.5 rounded-full text-sm font-bold uppercase tracking-wider">
              {essay.category}
            </span>
            <div className="flex items-center text-slate-400 text-sm">
              <Calendar size={16} className="mr-1" /> {essay.date}
            </div>
            <div className="flex items-center text-slate-400 text-sm">
              <Clock size={16} className="mr-1" /> {essay.readTime}
            </div>
          </div>

          <h1 className="text-4xl md:text-5xl font-black text-slate-900 leading-tight">
            {essay.title}
          </h1>

          {/* AI Summary Section */}
          {aiSummary && (
            <div className="bg-blue-50 border-l-4 border-blue-600 p-8 rounded-3xl animate-in fade-in slide-in-from-top-4 duration-500">
              <div className="flex items-center space-x-2 text-blue-700 font-black mb-4 uppercase tracking-widest text-sm">
                <Sparkles size={18} /> <span>✨ AI Insight Summary</span>
              </div>
              <div className="text-slate-700 leading-relaxed whitespace-pre-line font-medium">
                {aiSummary}
              </div>
            </div>
          )}

          <div className="flex items-center p-6 bg-slate-50 rounded-2xl italic text-slate-700 border border-slate-200">
            "{essay.summary}"
          </div>

          <div className="prose prose-lg prose-slate max-w-none text-slate-600 leading-loose space-y-6">
            {essay.content.split('\n').map((para, i) => (
              para.trim() && <p key={i}>{para.trim()}</p>
            ))}
          </div>
        </div>
      </div>
    </section>
  );

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans selection:bg-blue-100 selection:text-blue-900 transition-colors duration-300">
      {/* Navigation */}
      <nav className={`fixed top-0 w-full z-50 transition-all duration-300 ${isScrolled ? 'bg-white/80 backdrop-blur-md shadow-sm py-3' : 'bg-transparent py-6'}`}>
        <div className="container mx-auto px-6 flex justify-between items-center">
          <div 
            className="text-xl font-bold tracking-tight text-slate-900 cursor-pointer"
            onClick={handleGoBack}
          >
            HyunSoo <span className="text-blue-600">PARK</span>
          </div>
          <div className="hidden md:flex space-x-8 text-sm font-medium">
            <button onClick={handleGoBack} className={`hover:text-blue-600 transition-colors ${currentPage === 'home' ? 'text-blue-600 font-bold' : ''}`}>Home</button>
            <a href="#essays" className="hover:text-blue-600 transition-colors">Insights</a>
            <a href="#experience" className="hover:text-blue-600 transition-colors">Experience</a>
          </div>
          <button className="bg-slate-900 text-white px-5 py-2 rounded-full text-sm font-semibold hover:bg-blue-600 transition-all duration-300">
            Contact Me
          </button>
        </div>
      </nav>

      {/* Conditional Rendering based on state */}
      {currentPage === 'home' ? <HomePage /> : <EssayDetailPage essay={selectedEssay} />}

      {/* Footer */}
      <footer className="py-12 bg-slate-50 border-t border-slate-200 mt-20">
        <div className="container mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-6 text-slate-500 text-sm">
          <div className="font-bold text-slate-800">
            HyunSoo <span className="text-blue-600">PARK</span>
          </div>
          <div className="text-center md:text-left">
            © 2026 Tech & Strategy Essayist. All rights reserved. Powered by ✨ Gemini API
          </div>
          <div className="flex space-x-6">
            <Mail size={18} className="hover:text-blue-600 cursor-pointer" />
            <Linkedin size={18} className="hover:text-blue-600 cursor-pointer" />
          </div>
        </div>
      </footer>
    </div>
  );
};

export default App;
